name: Lint and Code Quality

on:
  push:
    branches: [main, master, develop]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files

  type-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate VERSION file for type checking
        shell: bash
        run: |
          echo '__version__ = "0.0.0.dev0"' > src/hatch_calvar_sample/VERSION

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy types-setuptools
          pip install -e .

      - name: Run mypy type checking
        run: |
          mypy src/hatch_calvar_sample --ignore-missing-imports --no-error-summary || true
          mypy src/hatch_calvar_sample --ignore-missing-imports

  complexity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install complexity tools
        run: |
          python -m pip install --upgrade pip
          pip install radon xenon

      - name: Check cyclomatic complexity
        shell: bash
        run: |
          echo "=== Cyclomatic Complexity Report ==="
          radon cc src/ -a -s || true
          echo ""
          echo "=== Maintainability Index ==="
          radon mi src/ -s || true

      - name: Check complexity thresholds
        shell: bash
        run: |
          echo "Checking complexity thresholds..."
          # Xenon will fail if complexity exceeds thresholds
          # A = 10, B = 15, C = 25 (lower is better)
          xenon src/ --max-absolute C --max-modules B --max-average A || echo "::warning::Some modules exceed complexity thresholds"
        continue-on-error: true

      - name: Generate complexity report
        shell: bash
        run: |
          radon cc src/ -j > complexity-report.json || true
          radon mi src/ -j > maintainability-report.json || true

      - name: Upload complexity reports
        uses: actions/upload-artifact@v4
        with:
          name: complexity-reports
          path: |
            complexity-report.json
            maintainability-report.json
          retention-days: 7

  changelog-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check CHANGELOG.md was updated
        shell: bash
        run: |
          echo "Checking if CHANGELOG.md was modified in this PR..."

          # Get the list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check if CHANGELOG.md is in the changed files
          if echo "$CHANGED_FILES" | grep -q "CHANGELOG.md"; then
            echo "✓ CHANGELOG.md has been updated"
          else
            echo "::warning::CHANGELOG.md was not updated in this PR"
            echo "Consider adding an entry to document your changes"
          fi

      - name: Validate CHANGELOG format
        shell: bash
        run: |
          echo "Validating CHANGELOG.md format..."

          # Check if CHANGELOG.md exists
          if [ ! -f CHANGELOG.md ]; then
            echo "::error::CHANGELOG.md not found"
            exit 1
          fi

          # Check for required sections
          if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
            echo "::warning::Missing [Unreleased] section in CHANGELOG.md"
          fi

          # Check for CalVer format entries (YYYY.MM.DD.MICRO)
          if grep -qE "## \[[0-9]{4}\.[0-9]{2}\.[0-9]{2}\.[0-9]+\]" CHANGELOG.md; then
            echo "✓ Found CalVer formatted entries"
          else
            echo "::notice::No CalVer formatted version entries found yet"
          fi

          echo "CHANGELOG validation completed"
